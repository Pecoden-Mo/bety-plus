<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¯ÙØ¹ Ø¢Ù…Ù† - Ø¨ÙŠØªÙŠ Ø¨Ù„Ø³</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
        direction: rtl;
      }
      .payment-container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .worker-info {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }
      .pricing-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 10px 0;
      }
      .pricing-total {
        border-top: 2px solid #667eea;
        margin-top: 20px;
        padding-top: 20px;
        font-size: 18px;
        font-weight: bold;
        color: #667eea;
      }
      .pay-button {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 20px;
      }
      .pay-button:hover {
        transform: translateY(-2px);
      }
      .pay-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .security-note {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="payment-container">
      <h1>Ø¯ÙØ¹ Ø¢Ù…Ù† ÙˆÙ…ÙˆØ«ÙˆÙ‚</h1>

      <div class="security-note">
        ğŸ”’ <strong>Ø¯ÙØ¹ Ø¢Ù…Ù† 100%:</strong> Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© Stripe Ø§Ù„Ø¢Ù…Ù†Ø©
        Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©. Ù†Ø­Ù† Ù„Ø§ Ù†Ø­ÙØ¸ Ø£Ùˆ Ù†ØµÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚ØªÙƒ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ©.
      </div>

      <div class="worker-info" id="workerInfo">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„Ø©</h3>
        <p>
          <strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="workerName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </p>
        <p>
          <strong>Ø§Ù„Ø´Ø±ÙƒØ©:</strong>
          <span id="workerCompany">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </p>
        <p>
          <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong>
          <span id="workerLocation">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </p>
      </div>

      <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h3>

      <div class="pricing-item">
        <span>Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¹Ø§Ù…Ù„Ø©:</span>
        <span id="basePrice">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>

      <div class="pricing-item">
        <span>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¶Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯):</span>
        <span id="guaranteeFee">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>

      <div class="pricing-item">
        <span>Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù†ØµØ©:</span>
        <span id="serviceFee">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>

      <div class="pricing-item">
        <span>Ø±Ø³ÙˆÙ… ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©:</span>
        <span id="deliveryFee">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>

      <div class="pricing-total">
        <div class="pricing-item">
          <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
          <span id="finalTotal">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
      </div>

      <button
        class="pay-button"
        id="payButton"
        onclick="initiatePayment()"
        disabled
      >
        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
      </button>
    </div>

    <script>
      // Get worker ID from URL or set it
      const workerId =
        new URLSearchParams(window.location.search).get('workerId') ||
        'YOUR_WORKER_ID';
      let pricingData = null;

      // Load pricing quote
      async function loadPricingQuote() {
        try {
          const response = await fetch(`/api/payment/quote/${workerId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          const result = await response.json();

          if (result.status === 'success') {
            updatePricingDisplay(result.data);
            pricingData = result.data.pricing;

            // Enable payment button
            const payButton = document.getElementById('payButton');
            payButton.textContent = `Ø§Ø¯ÙØ¹ ${pricingData.totalAmount.toLocaleString()} Ø¯Ø±Ù‡Ù… Ø¨Ø£Ù…Ø§Ù†`;
            payButton.disabled = false;
          }
        } catch (error) {
          console.error('Failed to load pricing:', error);
          alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±');
        }
      }

      // Update pricing display
      function updatePricingDisplay(data) {
        // Update worker info
        document.getElementById('workerName').textContent = data.worker.name;
        document.getElementById('workerCompany').textContent =
          data.worker.company;
        document.getElementById('workerLocation').textContent =
          data.worker.location;

        // Update pricing
        const pricing = data.pricing;
        document.getElementById('basePrice').textContent =
          `${pricing.basePrice.toLocaleString()} Ø¯Ø±Ù‡Ù…`;
        document.getElementById('guaranteeFee').textContent =
          `${pricing.guaranteeFee.toLocaleString()} Ø¯Ø±Ù‡Ù…`;
        document.getElementById('serviceFee').textContent =
          `${pricing.serviceFee.toLocaleString()} Ø¯Ø±Ù‡Ù…`;
        document.getElementById('deliveryFee').textContent =
          `${pricing.deliveryFee.toLocaleString()} Ø¯Ø±Ù‡Ù…`;
        document.getElementById('finalTotal').textContent =
          `${pricing.totalAmount.toLocaleString()} Ø¯Ø±Ù‡Ù…`;
      }

      // Initiate secure payment
      async function initiatePayment() {
        const payButton = document.getElementById('payButton');
        payButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†Ø©...';
        payButton.disabled = true;

        try {
          const response = await fetch('/api/payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify({
              workerId: workerId,
              serviceType: 'housemaid',
            }),
          });

          const result = await response.json();

          if (result.status === 'success') {
            // Redirect to Stripe Checkout
            window.location.href = result.data.checkoutUrl;
          } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯ÙØ¹: ' + result.message);
            payButton.textContent = `Ø§Ø¯ÙØ¹ ${pricingData.totalAmount.toLocaleString()} Ø¯Ø±Ù‡Ù… Ø¨Ø£Ù…Ø§Ù†`;
            payButton.disabled = false;
          }
        } catch (error) {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯ÙØ¹');
          payButton.textContent = `Ø§Ø¯ÙØ¹ ${pricingData.totalAmount.toLocaleString()} Ø¯Ø±Ù‡Ù… Ø¨Ø£Ù…Ø§Ù†`;
          payButton.disabled = false;
        }
      }

      // Load pricing on page load
      loadPricingQuote();
    </script>
  </body>
</html>
