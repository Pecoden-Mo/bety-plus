<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>دفع آمن - بيتي بلس</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
        direction: rtl;
      }
      .payment-container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .worker-info {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }
      .pricing-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 10px 0;
      }
      .pricing-total {
        border-top: 2px solid #667eea;
        margin-top: 20px;
        padding-top: 20px;
        font-size: 18px;
        font-weight: bold;
        color: #667eea;
      }
      .pay-button {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 20px;
      }
      .pay-button:hover {
        transform: translateY(-2px);
      }
      .pay-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .security-note {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="payment-container">
      <h1>دفع آمن وموثوق</h1>

      <div class="security-note">
        🔒 <strong>دفع آمن 100%:</strong> سيتم توجيهك إلى صفحة Stripe الآمنة
        لإدخال بيانات البطاقة. نحن لا نحفظ أو نصل إلى بيانات بطاقتك الائتمانية.
      </div>

      <div class="worker-info" id="workerInfo">
        <h3>معلومات العاملة</h3>
        <p>
          <strong>الاسم:</strong> <span id="workerName">جاري التحميل...</span>
        </p>
        <p>
          <strong>الشركة:</strong>
          <span id="workerCompany">جاري التحميل...</span>
        </p>
        <p>
          <strong>الموقع:</strong>
          <span id="workerLocation">جاري التحميل...</span>
        </p>
      </div>

      <h3>تفاصيل الفاتورة:</h3>

      <div class="pricing-item">
        <span>السعر للعاملة:</span>
        <span id="basePrice">جاري التحميل...</span>
      </div>

      <div class="pricing-item">
        <span>رسوم الضمان (قابلة للاسترداد):</span>
        <span id="guaranteeFee">جاري التحميل...</span>
      </div>

      <div class="pricing-item">
        <span>رسوم خدمة المنصة:</span>
        <span id="serviceFee">جاري التحميل...</span>
      </div>

      <div class="pricing-item">
        <span>رسوم توصيل العاملة:</span>
        <span id="deliveryFee">جاري التحميل...</span>
      </div>

      <div class="pricing-total">
        <div class="pricing-item">
          <span>الإجمالي:</span>
          <span id="finalTotal">جاري التحميل...</span>
        </div>
      </div>

      <button
        class="pay-button"
        id="payButton"
        onclick="initiatePayment()"
        disabled
      >
        جاري التحميل...
      </button>
    </div>

    <script>
      // Get worker ID from URL or set it
      const workerId =
        new URLSearchParams(window.location.search).get('workerId') ||
        'YOUR_WORKER_ID';
      let pricingData = null;

      // Load pricing quote
      async function loadPricingQuote() {
        try {
          const response = await fetch(`/api/payment/quote/${workerId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          const result = await response.json();

          if (result.status === 'success') {
            updatePricingDisplay(result.data);
            pricingData = result.data.pricing;

            // Enable payment button
            const payButton = document.getElementById('payButton');
            payButton.textContent = `ادفع ${pricingData.totalAmount.toLocaleString()} درهم بأمان`;
            payButton.disabled = false;
          }
        } catch (error) {
          console.error('Failed to load pricing:', error);
          alert('فشل في تحميل بيانات التسعير');
        }
      }

      // Update pricing display
      function updatePricingDisplay(data) {
        // Update worker info
        document.getElementById('workerName').textContent = data.worker.name;
        document.getElementById('workerCompany').textContent =
          data.worker.company;
        document.getElementById('workerLocation').textContent =
          data.worker.location;

        // Update pricing
        const pricing = data.pricing;
        document.getElementById('basePrice').textContent =
          `${pricing.basePrice.toLocaleString()} درهم`;
        document.getElementById('guaranteeFee').textContent =
          `${pricing.guaranteeFee.toLocaleString()} درهم`;
        document.getElementById('serviceFee').textContent =
          `${pricing.serviceFee.toLocaleString()} درهم`;
        document.getElementById('deliveryFee').textContent =
          `${pricing.deliveryFee.toLocaleString()} درهم`;
        document.getElementById('finalTotal').textContent =
          `${pricing.totalAmount.toLocaleString()} درهم`;
      }

      // Initiate secure payment
      async function initiatePayment() {
        const payButton = document.getElementById('payButton');
        payButton.textContent = 'جاري إنشاء جلسة الدفع الآمنة...';
        payButton.disabled = true;

        try {
          const response = await fetch('/api/payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify({
              workerId: workerId,
              serviceType: 'housemaid',
            }),
          });

          const result = await response.json();

          if (result.status === 'success') {
            // Redirect to Stripe Checkout
            window.location.href = result.data.checkoutUrl;
          } else {
            alert('فشل في إنشاء جلسة الدفع: ' + result.message);
            payButton.textContent = `ادفع ${pricingData.totalAmount.toLocaleString()} درهم بأمان`;
            payButton.disabled = false;
          }
        } catch (error) {
          alert('حدث خطأ في إنشاء جلسة الدفع');
          payButton.textContent = `ادفع ${pricingData.totalAmount.toLocaleString()} درهم بأمان`;
          payButton.disabled = false;
        }
      }

      // Load pricing on page load
      loadPricingQuote();
    </script>
  </body>
</html>
